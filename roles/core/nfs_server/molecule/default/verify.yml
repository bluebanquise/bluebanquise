---
- name: Verify
  hosts: all
  tasks:

    - name: Collect package facts
      package_facts:
        manager: auto

    - name: Collect services facts
      service_facts:

    - name: Collect services of zone public
      command: firewall-cmd --zone=public --list-all
      register: firewall_cmd_result

    - name: Check rpc-bind and nfs are in zone public
      assert:
        that: firewall_cmd_result.stdout |
                    regex_findall(("rpc-bind|nfs"), multiline=False) | length == 2

    - name: Assert nfs-utils and rpcbind are installed
      assert:
        that: "'{{item}}' in ansible_facts.packages"
      loop:
        - nfs-utils
        - rpcbind

    - name: Retrieve file system status
      stat:
        path: /etc/exports
      register: register_stat

    - name: Assert file /etc/exports exist
      assert:
        that: "register_stat.stat.exists"

    - name: Retrieve /opt/software in /etc/exports file
      lineinfile:
        path: /etc/exports
        regexp: "^/opt/software"
        state: absent
      check_mode: yes
      register: export_sw_result

    - name: Check /etc/exports file contains /opt/software line
      assert:
        that: export_sw_result.found

    - name: Retrieve /home in /etc/exports file
      lineinfile:
        path: /etc/exports
        regexp: "^/home"
        state: absent
      check_mode: yes
      register: export_home_result

    - name: Check /etc/exports file contains /home line
      assert:
        that: export_home_result.found

    - name: Check nfs-server and rpcbind are enabled
      assert:
        that:
          - "ansible_facts.services['{{ item }}.service'].status == 'enabled'"
      loop:
        - nfs-server
        - rpcbind
