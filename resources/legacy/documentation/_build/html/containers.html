

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>12. Containers &mdash; BlueBanquise Documentation 1.5.0 documentation</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="13. Stories" href="stories.html" />
    <link rel="prev" title="&lt;no title&gt;" href="slurm.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> BlueBanquise Documentation
          

          
            
            <img src="_static/logo.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                1.5
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="introduction.html">1. Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="vocabulary.html">2. Vocabulary</a></li>
<li class="toctree-l1"><a class="reference internal" href="training_sysadmin.html">3. [Training] - Cluster SysAdmin</a></li>
<li class="toctree-l1"><a class="reference internal" href="training_ansible.html">4. [Training] - Ansible</a></li>
<li class="toctree-l1"><a class="reference internal" href="bootstrap.html">5. [Core] - Bootstrap base system</a></li>
<li class="toctree-l1"><a class="reference internal" href="configure_bluebanquise.html">6. [Core] - Configure BlueBanquise</a></li>
<li class="toctree-l1"><a class="reference internal" href="deploy_bluebanquise.html">7. [Core] - Deploy BlueBanquise</a></li>
<li class="toctree-l1"><a class="reference internal" href="multiple_icebergs.html">8. [Core] - Manage multiple icebergs</a></li>
<li class="toctree-l1"><a class="reference internal" href="diskless.html">9. [Core] - Diskless</a></li>
<li class="toctree-l1"><a class="reference internal" href="high_availability.html">10. [Community] - High Availability</a></li>
<li class="toctree-l1"><a class="reference internal" href="monitoring.html">11. [Community] - Monitoring</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">12. Containers</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#podman">12.1. Podman</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#install-podman-and-grab-base-image">12.1.1. Install podman and grab base image</a></li>
<li class="toctree-l3"><a class="reference internal" href="#generic-ansible-ready-image">12.1.2. Generic ansible ready image</a></li>
<li class="toctree-l3"><a class="reference internal" href="#example-repositories-container">12.1.3. Example: repositories container</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="stories.html">13. Stories</a></li>
<li class="toctree-l1"><a class="reference internal" href="roles.html">14. Roles list</a></li>
<li class="toctree-l1"><a class="reference internal" href="references.html">15. References</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">BlueBanquise Documentation</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li><span class="section-number">12. </span>Containers</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="_sources/containers.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="containers">
<h1><span class="section-number">12. </span>Containers<a class="headerlink" href="#containers" title="Permalink to this headline">¶</a></h1>
<p>There are many ways to put BlueBanquise stack inside containers.
The stack was designed to be able to spread services over multiple management
nodes, and so also run in containers or VMs.</p>
<p>A very simple way is described here, but not designed for production. However,
this can be used as a starting point.</p>
<p>Podman was chosen as containers tool, as it allows simple systemd usage inside
containers without needed additional tuning or unsecure privileged containers.</p>
<div class="section" id="podman">
<h2><span class="section-number">12.1. </span>Podman<a class="headerlink" href="#podman" title="Permalink to this headline">¶</a></h2>
<div class="section" id="install-podman-and-grab-base-image">
<h3><span class="section-number">12.1.1. </span>Install podman and grab base image<a class="headerlink" href="#install-podman-and-grab-base-image" title="Permalink to this headline">¶</a></h3>
<p>Install podman:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>dnf config-manager --set-enabled PowerTools
dnf install -y @container-tools
</pre></div>
</div>
<p>Enable systemd in Podman:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>setsebool -P container_manage_cgroup true
</pre></div>
</div>
<p>Grab latest centos image:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>podman pull centos:latest
</pre></div>
</div>
</div>
<div class="section" id="generic-ansible-ready-image">
<h3><span class="section-number">12.1.2. </span>Generic ansible ready image<a class="headerlink" href="#generic-ansible-ready-image" title="Permalink to this headline">¶</a></h3>
<p>Create a generic image, that contains python3 only (centos <strong>W**ith
**P**ython**3</strong>).</p>
<p>First create centoswp3 dir:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>mkdir /root/centoswp3
cd /root/centoswp3
</pre></div>
</div>
<p>Create file Dockerfile with the following content:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>FROM centos

RUN dnf -y install python3; dnf clean all;

CMD [ &quot;/sbin/init&quot; ]
</pre></div>
</div>
<p>And build the new image, and name it centoswp3:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>podman build --tag centos:centoswp3 -f ./Dockerfile
</pre></div>
</div>
<p>Once done, check your new source image is ready:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="o">[</span>root@pc-200 centoswp3<span class="o">]</span><span class="c1"># podman images</span>
REPOSITORY                 TAG         IMAGE ID       CREATED         SIZE
localhost/centos           centoswp3   aa79704b7475   <span class="m">4</span> seconds ago   <span class="m">245</span> MB
docker.io/library/centos   latest      831691599b88   <span class="m">3</span> weeks ago     <span class="m">223</span> MB
<span class="o">[</span>root@pc-200 centoswp3<span class="o">]</span><span class="c1">#</span>
</pre></div>
</div>
</div>
<div class="section" id="example-repositories-container">
<h3><span class="section-number">12.1.3. </span>Example: repositories container<a class="headerlink" href="#example-repositories-container" title="Permalink to this headline">¶</a></h3>
<p>Now start a container, called repositories. There are two ways:</p>
<p>Unsecure but simpler:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="o">[</span>root@pc-200 centoswp3<span class="o">]</span><span class="c1"># podman run -d --net=host --name repositories centos:centoswp3</span>
225dd7fd411929b31d598c832d945b841c52f4a100ee1913a768249c8501a26e
<span class="o">[</span>root@pc-200 centoswp3<span class="o">]</span><span class="c1">#</span>
</pre></div>
</div>
<p>More secure, but less simple (need to specify ports to bind):</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="o">[</span>root@pc-200 ~<span class="o">]</span><span class="c1"># podman run -d -p 80:80 --name repositories centos:centoswp3</span>
571eb6e50217d8bf6953353350587b37da0e783eb4b2c0893738cfd44f7db8a0
<span class="o">[</span>root@pc-200 ~<span class="o">]</span><span class="c1">#</span>
</pre></div>
</div>
<p>Both ways work.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>80:80 means port 80 on the main host is mapped to port 80 of the
container. If you want to use a different port on the host, you can select any
available port. For example, 8080:80 would map the port 8080 of the host to the
port 80 of the container.</p>
</div>
<p>Check the container is running:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="o">[</span>root@pc-200 centoswp3<span class="o">]</span><span class="c1"># podman ps -a</span>
CONTAINER ID  IMAGE                       COMMAND     CREATED        STATUS            PORTS  NAMES
225dd7fd4119  localhost/centos:centoswp3  /sbin/init  <span class="m">4</span> seconds ago  Up <span class="m">3</span> seconds ago         repositories
<span class="o">[</span>root@pc-200 centoswp3<span class="o">]</span><span class="c1">#</span>
</pre></div>
</div>
<p>Now create a simple playbook my_playbook.yml, that contains the following:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="p p-Indicator">-</span> <span class="nt">hosts</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">repositories</span>
  <span class="nt">connection</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">podman</span>
  <span class="nt">tasks</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="s">&quot;package</span><span class="nv"> </span><span class="s">█</span><span class="nv"> </span><span class="s">Install</span><span class="nv"> </span><span class="s">httpd</span><span class="nv"> </span><span class="s">packages&quot;</span>
      <span class="nt">package</span><span class="p">:</span>
        <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">httpd</span>
        <span class="nt">state</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">present</span>
      <span class="nt">tags</span><span class="p">:</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">package</span>
    <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="s">&quot;service</span><span class="nv"> </span><span class="s">█</span><span class="nv"> </span><span class="s">Manage</span><span class="nv"> </span><span class="s">httpd</span><span class="nv"> </span><span class="s">services</span><span class="nv"> </span><span class="s">state&quot;</span>
      <span class="nt">service</span><span class="p">:</span>
        <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">httpd</span>
        <span class="nt">enabled</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>
        <span class="nt">state</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">started</span>
      <span class="nt">tags</span><span class="p">:</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">service</span>
</pre></div>
</div>
<p>Note the connection type, and that we specified the name of the target host, here the container name.</p>
<p>Now create a basic Ansible inventory with our container as an host:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>mkdir my_inventory
</pre></div>
</div>
<p>And create my_inventory/my_containers with the following content:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>repositories ansible_connection=podman ansible_python_interpreter=/usr/bin/python3
</pre></div>
</div>
<p>Now simply use ansible playbook to push configuration:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="o">[</span>root@pc-200 ~<span class="o">]</span><span class="c1"># ansible-playbook my_playbook.yml -i my_inventory</span>

PLAY <span class="o">[</span>repositories<span class="o">]</span> ************************************************************************************************

TASK <span class="o">[</span>Gathering Facts<span class="o">]</span> *********************************************************************************************
ok: <span class="o">[</span>repositories<span class="o">]</span>

TASK <span class="o">[</span>package █ Install httpd packages<span class="o">]</span> ****************************************************************************
changed: <span class="o">[</span>repositories<span class="o">]</span>

TASK <span class="o">[</span>service █ Manage httpd services state<span class="o">]</span> ***********************************************************************
changed: <span class="o">[</span>repositories<span class="o">]</span>

PLAY RECAP *********************************************************************************************************
repositories               : <span class="nv">ok</span><span class="o">=</span><span class="m">3</span>    <span class="nv">changed</span><span class="o">=</span><span class="m">2</span>    <span class="nv">unreachable</span><span class="o">=</span><span class="m">0</span>    <span class="nv">failed</span><span class="o">=</span><span class="m">0</span>    <span class="nv">skipped</span><span class="o">=</span><span class="m">0</span>    <span class="nv">rescued</span><span class="o">=</span><span class="m">0</span>    <span class="nv">ignored</span><span class="o">=</span><span class="m">0</span>

<span class="o">[</span>root@pc-200 ~<span class="o">]</span><span class="c1">#</span>
</pre></div>
</div>
<p>And check the httpd server from the container is running.</p>
<p>Here host is listening on 192.168.1.21:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="o">[</span>root@pc-200 ~<span class="o">]</span><span class="c1"># ip a</span>
<span class="m">1</span>: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu <span class="m">65536</span> qdisc noqueue state UNKNOWN group default qlen <span class="m">1000</span>
    link/loopback <span class="m">00</span>:00:00:00:00:00 brd <span class="m">00</span>:00:00:00:00:00
    inet <span class="m">127</span>.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host
       valid_lft forever preferred_lft forever
<span class="m">3</span>: eth1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class="m">1500</span> qdisc mq state UP group default qlen <span class="m">1000</span>
    link/ether XX:XX:XX:XX:XX:XX brd ff:ff:ff:ff:ff:ff
    inet <span class="m">192</span>.168.1.21/24 brd <span class="m">192</span>.168.1.255 scope global dynamic noprefixroute eth1
       valid_lft 64092sec preferred_lft 64092sec
<span class="o">[</span>root@pc-200 ~<span class="o">]</span><span class="c1">#</span>
</pre></div>
</div>
<p>To attach to the container, and tune few things inside, use the following command:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>podman exec -it repositories /bin/bash
</pre></div>
</div>
<p>To stop the container, use:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>podman stop repositories
</pre></div>
</div>
<p>To start it again, use:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>podman start repositories
</pre></div>
</div>
<p>Use a web browser to check http server is running (you will end up in apache test page).</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="stories.html" class="btn btn-neutral float-right" title="13. Stories" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="slurm.html" class="btn btn-neutral float-left" title="&lt;no title&gt;" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2019, Benoît Leveugle, Johnny Keats.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>