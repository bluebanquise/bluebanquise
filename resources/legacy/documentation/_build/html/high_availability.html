

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>10. [Community] - High Availability &mdash; BlueBanquise Documentation 1.5.0 documentation</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="11. [Community] - Monitoring" href="monitoring.html" />
    <link rel="prev" title="9. [Core] - Diskless" href="diskless.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> BlueBanquise Documentation
          

          
            
            <img src="_static/logo.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                1.5
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="introduction.html">1. Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="vocabulary.html">2. Vocabulary</a></li>
<li class="toctree-l1"><a class="reference internal" href="training_sysadmin.html">3. [Training] - Cluster SysAdmin</a></li>
<li class="toctree-l1"><a class="reference internal" href="training_ansible.html">4. [Training] - Ansible</a></li>
<li class="toctree-l1"><a class="reference internal" href="bootstrap.html">5. [Core] - Bootstrap base system</a></li>
<li class="toctree-l1"><a class="reference internal" href="configure_bluebanquise.html">6. [Core] - Configure BlueBanquise</a></li>
<li class="toctree-l1"><a class="reference internal" href="deploy_bluebanquise.html">7. [Core] - Deploy BlueBanquise</a></li>
<li class="toctree-l1"><a class="reference internal" href="multiple_icebergs.html">8. [Core] - Manage multiple icebergs</a></li>
<li class="toctree-l1"><a class="reference internal" href="diskless.html">9. [Core] - Diskless</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">10. [Community] - High Availability</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#create-ha-cluster">10.1. Create HA Cluster</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#ha-cluster-group">10.1.1. ha_cluster group</a></li>
<li class="toctree-l3"><a class="reference internal" href="#reference-node">10.1.2. Reference node</a></li>
<li class="toctree-l3"><a class="reference internal" href="#cluster-password">10.1.3. Cluster password</a></li>
<li class="toctree-l3"><a class="reference internal" href="#deploy-cluster">10.1.4. Deploy cluster</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#populate-cluster-with-resources">10.2. Populate cluster with resources</a></li>
<li class="toctree-l2"><a class="reference internal" href="#configure-cluster">10.3. Configure cluster</a></li>
<li class="toctree-l2"><a class="reference internal" href="#expanding-cluster">10.4. Expanding cluster</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="monitoring.html">11. [Community] - Monitoring</a></li>
<li class="toctree-l1"><a class="reference internal" href="containers.html">12. Containers</a></li>
<li class="toctree-l1"><a class="reference internal" href="stories.html">13. Stories</a></li>
<li class="toctree-l1"><a class="reference internal" href="roles.html">14. Roles list</a></li>
<li class="toctree-l1"><a class="reference internal" href="references.html">15. References</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">BlueBanquise Documentation</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li><span class="section-number">10. </span>[Community] - High Availability</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="_sources/high_availability.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="community-high-availability">
<h1><span class="section-number">10. </span>[Community] - High Availability<a class="headerlink" href="#community-high-availability" title="Permalink to this headline">¶</a></h1>
<p>In production environment, high availability is often needed to ensure
continuous cluster operations.</p>
<p>To achieve that, one of the possible solution is to setup an Active-Passive
HA (high availability) cluster. The BlueBanquise stack COMMUNITY
<strong>high_availability</strong> role can setup a Corosync - Pacemaker cluster.</p>
<p>Services then run as “resources” in that cluster, and migrate from one management
server to another. If one the management servers pool member crash, resources
running on it just migrate to another management to ensure continuous production.</p>
<img alt="_images/ha_cluster.svg" class="align-center" src="_images/ha_cluster.svg" /><p>It is assumed in the following part that your hardware is composed of multiple
management nodes and a storage array shared by all management.
Some resources need to store data (database, state, etc.) and so need a shared
storage space to recover when migrating from one management to another.</p>
<div class="section" id="create-ha-cluster">
<h2><span class="section-number">10.1. </span>Create HA Cluster<a class="headerlink" href="#create-ha-cluster" title="Permalink to this headline">¶</a></h2>
<p>It is assumed here that management nodes will be 2, and named management[1-2].
It is however highly recommended to have more management nodes, to allow safer
production.</p>
<p>First step is to follow standard process, to deploy an isolated management node.
We will assume that this first management node is deployed and named management1.</p>
<p>Once this node is ready, first step is to deploy an HA cluster on it.</p>
<div class="section" id="ha-cluster-group">
<h3><span class="section-number">10.1.1. </span>ha_cluster group<a class="headerlink" href="#ha-cluster-group" title="Permalink to this headline">¶</a></h3>
<p>In the inventory, create file <code class="docutils literal notranslate"><span class="pre">inventory/cluster/groups/ha_cluster</span></code> with the
following content:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>[ha_cluster]
management1
</pre></div>
</div>
<p>Then, create folder <code class="docutils literal notranslate"><span class="pre">inventory/group_vars/ha_cluster</span></code> and in this folder, create
file <code class="docutils literal notranslate"><span class="pre">ha_parameters.yml</span></code> with the following content:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">high_availability_cluster_nodes</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">management1</span>
      <span class="l l-Scalar l-Scalar-Plain">addrs</span><span class="p p-Indicator">:</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">management1</span>
</pre></div>
</div>
<p>Note that if your management nodes posses a second network to exchange, it is
better to add a second <code class="docutils literal notranslate"><span class="pre">addrs</span></code> so that HA cluster can use a backup network. For
example, if management1 can also be reached at <code class="docutils literal notranslate"><span class="pre">management1-lk1</span></code> from the
other management nodes, <code class="docutils literal notranslate"><span class="pre">ha_parameters.yml</span></code> should be defines this way:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">high_availability_cluster_nodes</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">management1</span>
      <span class="l l-Scalar l-Scalar-Plain">addrs</span><span class="p p-Indicator">:</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">management1</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">management1-lk1</span>
</pre></div>
</div>
</div>
<div class="section" id="reference-node">
<h3><span class="section-number">10.1.2. </span>Reference node<a class="headerlink" href="#reference-node" title="Permalink to this headline">¶</a></h3>
<p>The HA cluster need a reference node, that will be used to populate resources
into the cluster. Good practice is to define the first management, and use
extra-vars ansible-playbook options on the fly when this node is unavailable.</p>
<p>In file <code class="docutils literal notranslate"><span class="pre">inventory/group_vars/ha_cluster/ha_parameters.yml</span></code>, add the following
variable:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">high_availability_reference_node</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">management1</span>
</pre></div>
</div>
</div>
<div class="section" id="cluster-password">
<h3><span class="section-number">10.1.3. </span>Cluster password<a class="headerlink" href="#cluster-password" title="Permalink to this headline">¶</a></h3>
<p>Last step is to define cluster password.
Generate a new SHA512 has that match your desired password, and create the
dedicated variable in <code class="docutils literal notranslate"><span class="pre">inventory/group_vars/ha_cluster/ha_parameters.yml</span></code> file:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">high_availability_ha_cluster_password</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">$6$M3crarMVoUV3rALd$ZTre2CIyss7zOb4lkLoG23As9OAkYPw2BM88Y1F43n8CCyV5XWwAYEwBOrS8bcCBIMjIPdJG.ndOfzWyAVR4j0</span>
</pre></div>
</div>
<p>..note::
This is an example of SHA512 hash, that match <em>hacluster</em>.
Do not use this one in production.</p>
</div>
<div class="section" id="deploy-cluster">
<h3><span class="section-number">10.1.4. </span>Deploy cluster<a class="headerlink" href="#deploy-cluster" title="Permalink to this headline">¶</a></h3>
<p>Now simply execute the high_availability role on management1. If all goes
well, at the end, the HA cluster should be ready. Use <code class="docutils literal notranslate"><span class="pre">pcs</span> <span class="pre">status</span></code> command
to check HA cluster status at any time.</p>
</div>
</div>
<div class="section" id="populate-cluster-with-resources">
<h2><span class="section-number">10.2. </span>Populate cluster with resources<a class="headerlink" href="#populate-cluster-with-resources" title="Permalink to this headline">¶</a></h2>
<p>Now that HA cluster is running, it is time to populate it with resources.</p>
<p>BlueBanquise HA role organize by default resources by groups. Each group of
resources act as a collocation constraint: resources of a same group <strong>must</strong>
be running on the same server.
Then, in each group, definition list order act as a start order constraint:
resources <strong>must</strong> start in the same order than the definition list. If for any
reason a resource in the list fails to start, the remaining resources of the
list will not start.</p>
<p>The best example is the “repositories pack of resources”.</p>
<p>This group, called here repositories, contains fs mounting point resource, virtual
ip resource, and a service resource. All needs to be running on the same
server (constraint provided by the group) and service must not start if fs is not
mounted and virtual ip not created (constraint provided by start order).</p>
<p>To populate cluster with this group of resources, in file
<code class="docutils literal notranslate"><span class="pre">inventory/group_vars/ha_cluster/ha_parameters.yml</span></code>, add the following content:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">high_availability_resources</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">group</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">http</span>
    <span class="nt">resources</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="nt">id</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">fs-repositories</span>
        <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Filesystem</span>
        <span class="nt">arguments</span><span class="p">:</span> <span class="s">&quot;device=&#39;/dev/repositories&#39;</span><span class="nv"> </span><span class="s">directory=&#39;/var/www/html/repositories/&#39;</span><span class="nv"> </span><span class="s">fstype=&#39;ext4&#39;&quot;</span>
      <span class="p p-Indicator">-</span> <span class="nt">id</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">vip-http</span>
        <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">IPaddr2</span>
        <span class="nt">arguments</span><span class="p">:</span> <span class="s">&quot;ip=10.10.77.1</span><span class="nv"> </span><span class="s">cidr_netmask=255.255.0.0&quot;</span>
      <span class="p p-Indicator">-</span> <span class="nt">id</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">service-http</span>
        <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">systemd:httpd</span>
</pre></div>
</div>
<p>Then, simply re-execute the playbook to populate cluster with these resources.</p>
<p>You need to define this way each pack of resources to be put into HA.</p>
<p>For a full list of example, refer to the High Availability role readme,
section <strong>List of standard resources</strong>.</p>
<p>Once all resources are correctly populated, <strong>it is mandatory to deactivate
services handling</strong> by Ansible on this server. You do not want services to be
started by Ansible during playbooks execution, as critical services are now
managed by the HA cluster.</p>
<p>Create file <code class="docutils literal notranslate"><span class="pre">inventory/group_vars/ha_cluster/services.yml</span></code> with the following content:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">enable_services</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">false</span>
<span class="nt">start_services</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">false</span>
</pre></div>
</div>
<p>And replay whole management playbook on server to push new configuration.</p>
</div>
<div class="section" id="configure-cluster">
<h2><span class="section-number">10.3. </span>Configure cluster<a class="headerlink" href="#configure-cluster" title="Permalink to this headline">¶</a></h2>
<p>It is possible, using the role, to configure advanced elements of the cluster.</p>
<p>Please refer to the High Availability role readme.</p>
<p>By default, role supports adding/modifying clusters properties, adding stonith,
and defining advanced constraints.</p>
</div>
<div class="section" id="expanding-cluster">
<h2><span class="section-number">10.4. </span>Expanding cluster<a class="headerlink" href="#expanding-cluster" title="Permalink to this headline">¶</a></h2>
<p>Once all configuration is running with a single node, deploy other management nodes
using standard PXE process.</p>
<p>Expand now <code class="docutils literal notranslate"><span class="pre">ha_cluster</span></code> group. Edit file <code class="docutils literal notranslate"><span class="pre">inventory/group_vars/ha_cluster</span></code> and
add new managements (here management2):</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>[ha_cluster]
management1
management2
</pre></div>
</div>
<p>And add other managements into <code class="docutils literal notranslate"><span class="pre">inventory/group_vars/ha_cluster/ha_parameters.yml</span></code>:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">high_availability_cluster_nodes</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">management1</span>
      <span class="l l-Scalar l-Scalar-Plain">addrs</span><span class="p p-Indicator">:</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">management1</span>
  <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">management2</span>
      <span class="l l-Scalar l-Scalar-Plain">addrs</span><span class="p p-Indicator">:</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">management2</span>
</pre></div>
</div>
<p>Deploy then standard configuration on the other management nodes, using playbooks.
Since they are part of the ha_cluster group, their services will not start by default.</p>
<p>Now deploy the high_availability role on these management nodes. Once executed,
ensure using <code class="docutils literal notranslate"><span class="pre">pcs</span> <span class="pre">status</span></code> command that all the management nodes have now joined the
HA cluster. After few seconds (up to 1-2 minutes on some system), these nodes should
be marked as online, and resources can migrate on them on demand or in case of issues.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="monitoring.html" class="btn btn-neutral float-right" title="11. [Community] - Monitoring" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="diskless.html" class="btn btn-neutral float-left" title="9. [Core] - Diskless" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2019, Benoît Leveugle, Johnny Keats.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>