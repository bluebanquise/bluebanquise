

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>4. [Training] - Ansible &mdash; BlueBanquise Documentation 1.5.0 documentation</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="5. [Core] - Bootstrap base system" href="bootstrap.html" />
    <link rel="prev" title="3. [Training] - Cluster SysAdmin" href="training_sysadmin.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> BlueBanquise Documentation
          

          
            
            <img src="_static/logo.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                1.5
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="introduction.html">1. Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="vocabulary.html">2. Vocabulary</a></li>
<li class="toctree-l1"><a class="reference internal" href="training_sysadmin.html">3. [Training] - Cluster SysAdmin</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">4. [Training] - Ansible</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#install-ansible">4.1. Install Ansible</a></li>
<li class="toctree-l2"><a class="reference internal" href="#minimal-inventory">4.2. Minimal inventory</a></li>
<li class="toctree-l2"><a class="reference internal" href="#ansible-commands">4.3. Ansible commands</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#ansible">4.3.1. ansible</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#version">4.3.1.1. Version</a></li>
<li class="toctree-l4"><a class="reference internal" href="#ping-an-host-or-all-hosts">4.3.1.2. Ping an host or all hosts</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#ansible-inventory">4.3.2. ansible-inventory</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#groups-and-hosts">4.3.2.1. Groups and hosts</a></li>
<li class="toctree-l4"><a class="reference internal" href="#host-variables">4.3.2.2. Host variables</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#ansible-playbook">4.3.3. ansible-playbook</a></li>
<li class="toctree-l3"><a class="reference internal" href="#debug">4.3.4. Debug</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#variables-and-groups">4.4. Variables and groups</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#adding-variables">4.4.1. Adding variables</a></li>
<li class="toctree-l3"><a class="reference internal" href="#configuring-groups">4.4.2. Configuring groups</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#in-yaml">4.4.2.1. In YAML</a></li>
<li class="toctree-l4"><a class="reference internal" href="#in-ansible-syntax">4.4.2.2. In Ansible syntax</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#variables-precedence">4.4.3. Variables precedence</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#roles-and-playbooks">4.5. Roles and playbooks</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#role">4.5.1. Role</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#task">4.5.1.1. Task</a></li>
<li class="toctree-l4"><a class="reference internal" href="#template">4.5.1.2. Template</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#playbook">4.5.2. Playbook</a></li>
<li class="toctree-l3"><a class="reference internal" href="#jinja2">4.5.3. Jinja2</a></li>
<li class="toctree-l3"><a class="reference internal" href="#task-again">4.5.4. Task again</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#debug-module">4.5.4.1. Debug module</a></li>
<li class="toctree-l4"><a class="reference internal" href="#registers">4.5.4.2. Registers</a></li>
<li class="toctree-l4"><a class="reference internal" href="#loops">4.5.4.3. Loops</a></li>
<li class="toctree-l4"><a class="reference internal" href="#conditionals">4.5.4.4. Conditionals</a></li>
<li class="toctree-l4"><a class="reference internal" href="#tags">4.5.4.5. Tags</a></li>
<li class="toctree-l4"><a class="reference internal" href="#notify">4.5.4.6. Notify</a></li>
<li class="toctree-l4"><a class="reference internal" href="#other-useful-modules">4.5.4.7. Other useful modules</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="bootstrap.html">5. [Core] - Bootstrap base system</a></li>
<li class="toctree-l1"><a class="reference internal" href="configure_bluebanquise.html">6. [Core] - Configure BlueBanquise</a></li>
<li class="toctree-l1"><a class="reference internal" href="deploy_bluebanquise.html">7. [Core] - Deploy BlueBanquise</a></li>
<li class="toctree-l1"><a class="reference internal" href="multiple_icebergs.html">8. [Core] - Manage multiple icebergs</a></li>
<li class="toctree-l1"><a class="reference internal" href="diskless.html">9. [Core] - Diskless</a></li>
<li class="toctree-l1"><a class="reference internal" href="high_availability.html">10. [Community] - High Availability</a></li>
<li class="toctree-l1"><a class="reference internal" href="monitoring.html">11. [Community] - Monitoring</a></li>
<li class="toctree-l1"><a class="reference internal" href="containers.html">12. Containers</a></li>
<li class="toctree-l1"><a class="reference internal" href="stories.html">13. Stories</a></li>
<li class="toctree-l1"><a class="reference internal" href="roles.html">14. Roles list</a></li>
<li class="toctree-l1"><a class="reference internal" href="references.html">15. References</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">BlueBanquise Documentation</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li><span class="section-number">4. </span>[Training] - Ansible</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="_sources/training_ansible.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="training-ansible">
<h1><span class="section-number">4. </span>[Training] - Ansible<a class="headerlink" href="#training-ansible" title="Permalink to this headline">¶</a></h1>
<p>To understand how <strong>BlueBanquise</strong> works, it is essential to learn basis of
Ansible.</p>
<p>This section tries to provide key knowledge to at least be able to manipulate
and edit the stack to your needs.</p>
<p>Note that if you are new to cluster management system administration,
<a class="reference external" href="https://github.com/oxedions/admin_sys_baremetal_tutorial">a full manual tutorial is available on github.</a></p>
<div class="section" id="install-ansible">
<h2><span class="section-number">4.1. </span>Install Ansible<a class="headerlink" href="#install-ansible" title="Permalink to this headline">¶</a></h2>
<p>There are multiple ways to install Ansible. Everything is described on the
<a class="reference external" href="https://docs.ansible.com/ansible/latest/installation_guide/intro_installation.html">main Ansible documentation</a></p>
<p>If you wish only to learn Ansible, simplest way is
<a class="reference external" href="https://docs.ansible.com/ansible/latest/installation_guide/intro_installation.html#installing-ansible-with-pip">to use pip (or pip3)</a></p>
<p>If you wish to install Ansible on a production system, use your operating system
packages manager.</p>
</div>
<div class="section" id="minimal-inventory">
<h2><span class="section-number">4.2. </span>Minimal inventory<a class="headerlink" href="#minimal-inventory" title="Permalink to this headline">¶</a></h2>
<p>Now that Ansible is installed on your system, edit /etc/hosts file, and add
“management1” on localhost line:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4 management1
::1         localhost localhost.localdomain localhost6 localhost6.localdomain6
</pre></div>
</div>
<p>Then, create some needed directories and files:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>mkdir /etc/ansible/inventory
mkdir /etc/ansible/inventory/group_vars
mkdir /etc/ansible/inventory/group_vars/all
mkdir /etc/ansible/roles
mkdir /etc/ansible/playbooks
</pre></div>
</div>
<p>And edit /etc/ansible/ansible.cfg line to fix /etc/ansible/inventory as default
inventory folder:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>[defaults]
inventory      = /etc/ansible/inventory
</pre></div>
</div>
<p>Also set, in this same file /etc/ansible/ansible.cfg, the roles_path value to
/etc/ansible/roles:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>roles_path    = /etc/ansible/roles
</pre></div>
</div>
<p>Finally, add management1 host into the inventory. Create a file called
/etc/ansible/inventory/myhost.yml with the following content:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">management1</span>
</pre></div>
</div>
<p>Our very basic Ansible configuration is done. But one thing remains: we need to
ensure our host (management1) can ssh to itself without password, as Ansible
relies fully on the ssh to connect to remote hosts.</p>
<p>Let’s generate a ssh key (press enter multiple time):</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ssh-keygen -N <span class="s2">&quot;&quot;</span>
</pre></div>
</div>
<p>Ensure you can ssh on management1 using a password:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="o">[</span>root@management1 <span class="o">]</span><span class="c1"># ssh management1</span>
The authenticity of host <span class="s1">&#39;management1 (10.10.0.1)&#39;</span> can<span class="s1">&#39;t be established.</span>
<span class="s1">ECDSA key fingerprint is SHA256:XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX</span>
<span class="s1">ECDSA key fingerprint is MD5:XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX.</span>
<span class="s1">Are you sure you want to continue connecting (yes/no)? yes</span>
<span class="s1">Warning: Permanently added &#39;</span>management1,10.10.0.1<span class="s1">&#39; (ECDSA) to the list of known hosts.</span>
<span class="s1">root@management1&#39;</span>s password:
<span class="o">[</span>root@management1 ~<span class="o">]</span><span class="c1">#</span>
</pre></div>
</div>
<p>If ok, then deploy ssh public key to allow password less authentication, and
ensure you can now ssh with the key:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>[root@management1 ~]# ssh-copy-id management1
/usr/bin/ssh-copy-id: INFO: Source of key(s) to be installed: &quot;/root/.ssh/id_rsa.pub&quot;
root@management1&#39;s password:
Number of key(s) added: 1
[root@management1 ~]# ssh management1
[root@management1 ~]#
</pre></div>
</div>
<p>Finally, check Ansible can connect to management1, and report hosts is up:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="o">[</span>root@management1 ~<span class="o">]</span><span class="c1"># ansible all -m ping</span>
management1 <span class="p">|</span> <span class="nv">SUCCESS</span> <span class="o">=</span>&gt; <span class="o">{</span>
    <span class="s2">&quot;changed&quot;</span>: false,
    <span class="s2">&quot;ping&quot;</span>: <span class="s2">&quot;pong&quot;</span>
<span class="o">}</span>
<span class="o">[</span>root@management1 ~<span class="o">]</span><span class="c1">#</span>
</pre></div>
</div>
<p>Let’s see the available and useful commands now.</p>
</div>
<div class="section" id="ansible-commands">
<h2><span class="section-number">4.3. </span>Ansible commands<a class="headerlink" href="#ansible-commands" title="Permalink to this headline">¶</a></h2>
<div class="section" id="ansible">
<h3><span class="section-number">4.3.1. </span>ansible<a class="headerlink" href="#ansible" title="Permalink to this headline">¶</a></h3>
<p>The <strong>ansible</strong> command provides few interesting features.</p>
<div class="section" id="version">
<h4><span class="section-number">4.3.1.1. </span>Version<a class="headerlink" href="#version" title="Permalink to this headline">¶</a></h4>
<p>First command is to check current Ansible version. It should be &gt;= 2.9.13:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ansible --version
</pre></div>
</div>
</div>
<div class="section" id="ping-an-host-or-all-hosts">
<h4><span class="section-number">4.3.1.2. </span>Ping an host or all hosts<a class="headerlink" href="#ping-an-host-or-all-hosts" title="Permalink to this headline">¶</a></h4>
<p>Use the following command to check if Ansible can contact a specific registered
host:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ansible management1 -m ping
</pre></div>
</div>
<p>Or all hosts:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ansible all -m ping
</pre></div>
</div>
<p>Also, it is possible to gather <strong>facts</strong>. Facts are dynamic variables,
accessible only when Ansible is running on the target. Facts provides live
information about the target: it’s running kernel, it’s Linux distribution,
network or cpu information, etc.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ansible -m setup --tree /dev/shm/ management1
</pre></div>
</div>
<p>Then, open file /dev/shm/management1 to check its content and the result of
facts gathering.</p>
</div>
</div>
<div class="section" id="ansible-inventory">
<h3><span class="section-number">4.3.2. </span>ansible-inventory<a class="headerlink" href="#ansible-inventory" title="Permalink to this headline">¶</a></h3>
<p>Ansible inventory command is extremely useful and will be massively used on this
documentation.</p>
<p>This command allows to gather information from your inventory and check the
expected output.</p>
<div class="section" id="groups-and-hosts">
<h4><span class="section-number">4.3.2.1. </span>Groups and hosts<a class="headerlink" href="#groups-and-hosts" title="Permalink to this headline">¶</a></h4>
<p>The command:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ansible-inventory --graph
</pre></div>
</div>
<p>Provide information about groups and hosts inside each group:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>@all:
  <span class="p">|</span>--@ungrouped:
  <span class="p">|</span>  <span class="p">|</span>--management1
</pre></div>
</div>
<p>It is possible to see here that management1 is member of group &#64;ungrouped,
which is part of group &#64;all.
More will be seen later in this documentation.</p>
</div>
<div class="section" id="host-variables">
<h4><span class="section-number">4.3.2.2. </span>Host variables<a class="headerlink" href="#host-variables" title="Permalink to this headline">¶</a></h4>
<p>To output variables for a specific host, and check for example your variable
precedence mechanism provided what is expected, use:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ansible-inventory --yaml --host management1
</pre></div>
</div>
<p>For now, there are no available variables in the inventories, so output will
be {}.</p>
</div>
</div>
<div class="section" id="ansible-playbook">
<h3><span class="section-number">4.3.3. </span>ansible-playbook<a class="headerlink" href="#ansible-playbook" title="Permalink to this headline">¶</a></h3>
<p>This command is used to run playbooks, and ask Ansible to execute tasks on
desired host(s). This is the most used command when using <strong>BlueBanquise</strong>.</p>
<p>Important parameters are:</p>
<ul class="simple">
<li><p><cite>-e</cite> or <cite>–extra-vars</cite>, which allows to provide additional variables for execution (keep in mind that variables set here win the whole precedence)</p></li>
<li><p><cite>-t</cite> or <cite>–tags</cite>, which allows to execute only specific tasks or part of tasks (seen later)</p></li>
<li><p><cite>-s</cite> or <cite>–skip-tags</cite>, which allows to not execute some specific tasks or part of tasks (seen later)</p></li>
<li><p><cite>–list-tasks</cite>, which allows to list all tasks related to roles used in the playbook, and order they will be executed</p></li>
<li><p><cite>–start-at-task</cite>, which allows to start/restart playbook at a desired task (to be combined with <cite>–list-tasks</cite>)</p></li>
<li><p><cite>–list-tags</cite>, which allows to list all tags seen during this playbook execution</p></li>
<li><p><cite>–limit</cite>, which limit the playbook execution to a specific list of hosts (if using a group has default host for example)</p></li>
</ul>
</div>
<div class="section" id="debug">
<h3><span class="section-number">4.3.4. </span>Debug<a class="headerlink" href="#debug" title="Permalink to this headline">¶</a></h3>
<p>All of these commands accept verbose flags with -v, -vv, -vvv, etc. The more v,
the more verbose.</p>
<p>Also, it is possible to execute all of them with the variable ANSIBLE_DEBUG=1
set, which will dramatically increase output information (but unfortunately not
always relevant to our needs…).</p>
<p>For example, a very verbose execution would be:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">ANSIBLE_DEBUG</span><span class="o">=</span><span class="m">1</span> ansible -m ping management1 -vvv
</pre></div>
</div>
</div>
</div>
<div class="section" id="variables-and-groups">
<h2><span class="section-number">4.4. </span>Variables and groups<a class="headerlink" href="#variables-and-groups" title="Permalink to this headline">¶</a></h2>
<p>Now that all important commands have been seen, it is time to add some variables
inside the inventory, and play with groups.</p>
<div class="section" id="adding-variables">
<h3><span class="section-number">4.4.1. </span>Adding variables<a class="headerlink" href="#adding-variables" title="Permalink to this headline">¶</a></h3>
<p>We are going to add few variables, at different positions in the inventories.</p>
<p>Create file /etc/ansible/inventory/group_vars/all/my_ship.yml with the following
content:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">destination</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Deliani</span>
<span class="nt">my_ship</span><span class="p">:</span>
  <span class="nt">model</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">USP Talon Light Fighter</span>
  <span class="nt">price</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">6000</span> <span class="c1"># in cr</span>
  <span class="nt">equipment</span><span class="p">:</span>
    <span class="nt">generator</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Advanced MicroFusion</span>
    <span class="nt">shield</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Structural Integrity Field</span>
    <span class="nt">front_gun</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Pulse-Cannon</span>
    <span class="nt">sidekicks</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">Plasma Storm</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">Zica SuperCharger</span>
</pre></div>
</div>
<p>Now, ensure management1 can see these variables:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="o">[</span>root@ ~<span class="o">]</span><span class="c1"># ansible-inventory --yaml --host management1</span>
destination: Deliani
my_ship:
  equipment:
    front_gun: Pulse-Cannon
    generator: Advanced MicroFusion
    shield: Structural Integrity Field
    sidekicks:
    - Plasma Storm
    - Zica SuperCharger
  model: USP Talon Light Fighter
  price: <span class="m">6000</span>
<span class="o">[</span>root@ ~<span class="o">]</span><span class="c1">#</span>
</pre></div>
</div>
<p>Nice, we can now use these variables for management1 when working on it.</p>
<p>Let’s add 2 other hosts: login1 and nfs1.</p>
<p>Edit file /etc/ansible/inventory/myhost.yml to obtain:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>management1
login1
nfs1
</pre></div>
</div>
<p>And now let’s check login1 (when will exist) can also access these variables:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="o">[</span>root@ ~<span class="o">]</span><span class="c1"># ansible-inventory --yaml --host login1</span>
destination: Deliani
my_ship:
  equipment:
    front_gun: Pulse-Cannon
    generator: Advanced MicroFusion
    shield: Structural Integrity Field
    sidekicks:
    - Plasma Storm
    - Zica SuperCharger
  model: USP Talon Light Fighter
  price: <span class="m">6000</span>
<span class="o">[</span>root@ ~<span class="o">]</span><span class="c1">#</span>
</pre></div>
</div>
<p>Perfect. It is time to play with groups, before coming back to variables to work
on variables precedence.</p>
</div>
<div class="section" id="configuring-groups">
<h3><span class="section-number">4.4.2. </span>Configuring groups<a class="headerlink" href="#configuring-groups" title="Permalink to this headline">¶</a></h3>
<p>Lets check current groups:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="o">[</span>root@ ~<span class="o">]</span><span class="c1"># ansible-inventory --graph</span>
@all:
  <span class="p">|</span>--@ungrouped:
  <span class="p">|</span>  <span class="p">|</span>--login1
  <span class="p">|</span>  <span class="p">|</span>--management1
  <span class="p">|</span>  <span class="p">|</span>--nfs1
<span class="o">[</span>root@ ~<span class="o">]</span><span class="c1">#</span>
</pre></div>
</div>
<p>All our hosts belong to the ungrouped group and to the all group. But we want to
be able to assign specific variables to each kind of equipment. We need to
create groups.</p>
<p>There are two ways to create groups. In YAML, directly in the hosts files, or
using specific Ansible syntax in separate files. Both are useful, and we will
combine them.</p>
<div class="section" id="in-yaml">
<h4><span class="section-number">4.4.2.1. </span>In YAML<a class="headerlink" href="#in-yaml" title="Permalink to this headline">¶</a></h4>
<p>Edit again the /etc/ansible/inventory/myhost.yml file, and this time let’s use
real YAML:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">master</span><span class="p">:</span>
  <span class="nt">hosts</span><span class="p">:</span>
    <span class="nt">management1</span><span class="p">:</span>
<span class="nt">slaves</span><span class="p">:</span>
  <span class="nt">hosts</span><span class="p">:</span>
    <span class="nt">login1</span><span class="p">:</span>
    <span class="nt">nfs1</span><span class="p">:</span>
</pre></div>
</div>
<p>Now, let’s check again groups:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="o">[</span>root@ ~<span class="o">]</span><span class="c1"># ansible-inventory --graph</span>
@all:
  <span class="p">|</span>--@master:
  <span class="p">|</span>  <span class="p">|</span>--management1
  <span class="p">|</span>--@slaves:
  <span class="p">|</span>  <span class="p">|</span>--login1
  <span class="p">|</span>  <span class="p">|</span>--nfs1
  <span class="p">|</span>--@ungrouped:
<span class="o">[</span>root@ ~<span class="o">]</span><span class="c1">#</span>
</pre></div>
</div>
<p>We can see that management1 is now member of group master, and that login1 and
nfs1 are member of group slaves.</p>
<p>The special string <strong>hosts</strong> in this file define that the string above is a
group, and that strings bellow are hosts member of this group.</p>
<p>It is also possible to set groups in a group in this same file. Edit it again:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">my_nodes</span><span class="p">:</span>
  <span class="nt">children</span><span class="p">:</span>
    <span class="nt">master</span><span class="p">:</span>
      <span class="nt">hosts</span><span class="p">:</span>
        <span class="nt">management1</span><span class="p">:</span>
    <span class="nt">slaves</span><span class="p">:</span>
      <span class="nt">hosts</span><span class="p">:</span>
        <span class="nt">login1</span><span class="p">:</span>
        <span class="nt">nfs1</span><span class="p">:</span>
</pre></div>
</div>
<p>And result:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="o">[</span>root@ ~<span class="o">]</span><span class="c1"># ansible-inventory --graph</span>
@all:
  <span class="p">|</span>--@my_nodes:
  <span class="p">|</span>  <span class="p">|</span>--@master:
  <span class="p">|</span>  <span class="p">|</span>  <span class="p">|</span>--management1
  <span class="p">|</span>  <span class="p">|</span>--@slaves:
  <span class="p">|</span>  <span class="p">|</span>  <span class="p">|</span>--login1
  <span class="p">|</span>  <span class="p">|</span>  <span class="p">|</span>--nfs1
  <span class="p">|</span>--@ungrouped:
<span class="o">[</span>root@ ~<span class="o">]</span><span class="c1">#</span>
</pre></div>
</div>
<p>The <strong>children</strong> string define that the string above is a group that contains
bellow group(s).</p>
</div>
<div class="section" id="in-ansible-syntax">
<h4><span class="section-number">4.4.2.2. </span>In Ansible syntax<a class="headerlink" href="#in-ansible-syntax" title="Permalink to this headline">¶</a></h4>
<p>The second way to create groups is to use the Ansible native syntax, which can
be simpler in some cases.</p>
<p>Create a file /etc/ansible/inventory/mygroups and set the following content:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>[colors:children]
blue
red

[blue]
management1
login1

[red]
nfs1
</pre></div>
</div>
<p>And check the result:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="o">[</span>root@ ~<span class="o">]</span><span class="c1"># ansible-inventory --graph</span>
@all:
  <span class="p">|</span>--@colors:
  <span class="p">|</span>  <span class="p">|</span>--@blue:
  <span class="p">|</span>  <span class="p">|</span>  <span class="p">|</span>--login1
  <span class="p">|</span>  <span class="p">|</span>  <span class="p">|</span>--management1
  <span class="p">|</span>  <span class="p">|</span>--@red:
  <span class="p">|</span>  <span class="p">|</span>  <span class="p">|</span>--nfs1
  <span class="p">|</span>--@my_nodes:
  <span class="p">|</span>  <span class="p">|</span>--@master:
  <span class="p">|</span>  <span class="p">|</span>  <span class="p">|</span>--management1
  <span class="p">|</span>  <span class="p">|</span>--@slaves:
  <span class="p">|</span>  <span class="p">|</span>  <span class="p">|</span>--login1
  <span class="p">|</span>  <span class="p">|</span>  <span class="p">|</span>--nfs1
  <span class="p">|</span>--@ungrouped:
<span class="o">[</span>root@ ~<span class="o">]</span><span class="c1">#</span>
</pre></div>
</div>
<p>Same concept applies here, with different syntax.</p>
<p>Note that a host can be part of multiple groups.</p>
<p>You can find more information and examples
<a class="reference external" href="https://docs.ansible.com/ansible/latest/user_guide/intro_inventory.html">here on intro_inventory</a> .</p>
</div>
</div>
<div class="section" id="variables-precedence">
<h3><span class="section-number">4.4.3. </span>Variables precedence<a class="headerlink" href="#variables-precedence" title="Permalink to this headline">¶</a></h3>
<p>Time to use all these groups and make full usage of the inventory structure.</p>
<p>If you remember precedence system in Vocabulary section
(more <a class="reference external" href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_variables.html#variable-precedence-where-should-i-put-a-variable">here on Ansible dedicated page</a> )
group_vars/all is in position 4 in the precedence. This is where we set our
spaceship variables.</p>
<p>Let’s say now we wish to change our ship destination for management1 node only.</p>
<p>Check current destination for all hosts:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="o">[</span>root@ ~<span class="o">]</span><span class="c1"># ansible-inventory --yaml --host management1 | grep destination</span>
  destination: Deliani
<span class="o">[</span>root@ ~<span class="o">]</span><span class="c1"># ansible-inventory --yaml --host login1 | grep destination</span>
  destination: Deliani
<span class="o">[</span>root@ ~<span class="o">]</span><span class="c1"># ansible-inventory --yaml --host nfs1 | grep destination</span>
  destination: Deliani
<span class="o">[</span>root@ ~<span class="o">]</span><span class="c1">#</span>
</pre></div>
</div>
<p>We can redefine the variable in group_vars/all (that apply to all hosts in the
&#64;all group, so everyone), but we only want to impact management1 node.</p>
<p>In the precedence list, you can see that inventory host_vars are in position 9,
so they will win against position 4 of group_vars/all. Let’s use this.</p>
<p>Edit file /etc/ansible/inventory/myhost.yml and add a destination
variable under management1:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">my_nodes</span><span class="p">:</span>
  <span class="nt">children</span><span class="p">:</span>
    <span class="nt">master</span><span class="p">:</span>
      <span class="nt">hosts</span><span class="p">:</span>
        <span class="nt">management1</span><span class="p">:</span>
          <span class="nt">destination</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Ixmucane</span>
    <span class="nt">slaves</span><span class="p">:</span>
      <span class="nt">hosts</span><span class="p">:</span>
        <span class="nt">login1</span><span class="p">:</span>
        <span class="nt">nfs1</span><span class="p">:</span>
</pre></div>
</div>
<p>And check destinations again:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="o">[</span>root@ ~<span class="o">]</span><span class="c1"># ansible-inventory --yaml --host management1 | grep destination</span>
  destination: Ixmucane
<span class="o">[</span>root@ ~<span class="o">]</span><span class="c1"># ansible-inventory --yaml --host login1 | grep destination</span>
  destination: Deliani
<span class="o">[</span>root@ ~<span class="o">]</span><span class="c1"># ansible-inventory --yaml --host nfs1 | grep destination</span>
  destination: Deliani
<span class="o">[</span>root@ ~<span class="o">]</span><span class="c1">#</span>
</pre></div>
</div>
<p>Perfect.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>We could also have used a file in inventory/host_vars/management1/new_values..
Setting a variable in the host definition file above the host is equivalent to
using host_vars folder. But host_vars folder is difficult to use when having a
very large number of hosts, which is why in <strong>BlueBanquise</strong> we are often
using directly the host file.</p>
</div>
<p>Let’s say now we want to change the model of spaceship of all the slave nodes.
So not a single host, but all slave members hosts.</p>
<p>We are going to use level 6 in variables precedence: group_vars/. Create a
directory called <em>slave</em> (same name than the group we want to work with) in
group_vars:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>mkdir /etc/ansible/inventory/group_vars/slaves
</pre></div>
</div>
<p>Then, create file /etc/ansible/inventory/group_vars/slaves/myship.yml with the
following content:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">my_ship</span><span class="p">:</span>
  <span class="nt">equipment</span><span class="p">:</span>
    <span class="nt">front_gun</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Pulse-Cannon</span>
    <span class="nt">generator</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Advanced MicroFusion</span>
    <span class="nt">shield</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Structural Integrity Field</span>
    <span class="nt">sidekicks</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">Plasma Storm</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">Zica SuperCharger</span>
  <span class="nt">model</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Gencore Maelstrom</span>
  <span class="nt">price</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">6000</span>
</pre></div>
</div>
<p>And check variables of hosts:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="o">[</span>root@ ~<span class="o">]</span><span class="c1"># ansible-inventory --yaml --host management1 | grep model</span>
  model: USP Talon Light Fighter
<span class="o">[</span>root@ ~<span class="o">]</span><span class="c1"># ansible-inventory --yaml --host login1 | grep model</span>
  model: Gencore Maelstrom
<span class="o">[</span>root@ ~<span class="o">]</span><span class="c1"># ansible-inventory --yaml --host nfs1 | grep model</span>
  model: Gencore Maelstrom
<span class="o">[</span>root@ ~<span class="o">]</span><span class="c1">#</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>We had to add the whole dictionary in group_vars/slaves/myship.yml.
This is due to the <strong>replace</strong> hash_behaviour of Ansible, as the <strong>merge</strong>
version is deprecated. If you wish to avoid having to replace all variables
like here, try to avoid massive dictionaries when not needed.</p>
</div>
<p>Perfect. Remember the pizza in Vocabulary section. Ansible just flatten the
whole inventory, using precedence, and you obtain variables.</p>
<p>Last point for this part, remember that in variable’s precedence, extra_vars is
level 22 and always win, so adding extra vars when executing Ansible later will
allow us to force variables at execution time for testing purposes or just
because we need it.</p>
</div>
</div>
<div class="section" id="roles-and-playbooks">
<h2><span class="section-number">4.5. </span>Roles and playbooks<a class="headerlink" href="#roles-and-playbooks" title="Permalink to this headline">¶</a></h2>
<p>Time to apply some configuration on our target host.</p>
<p>We are going to create a role that install a web server package, create a very
basic web page with our ship’s information, and start the web server service.</p>
<div class="section" id="role">
<h3><span class="section-number">4.5.1. </span>Role<a class="headerlink" href="#role" title="Permalink to this headline">¶</a></h3>
<p>Create a role called “shipyard”, with needed folders:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>mkdir /etc/ansible/roles/shipyard
mkdir /etc/ansible/roles/shipyard/tasks
mkdir /etc/ansible/roles/shipyard/templates
</pre></div>
</div>
<p>Tasks folder contains tasks to perform, and main.yml file inside will be the
starting point for Ansible. Templates folder will contain our templates
(configuration files) in Jinja2 language.</p>
<div class="section" id="task">
<h4><span class="section-number">4.5.1.1. </span>Task<a class="headerlink" href="#task" title="Permalink to this headline">¶</a></h4>
<p>Create file /etc/ansible/roles/shipyard/tasks/main.yml with the following
content:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nn">---</span>

<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Package</span>
  <span class="nt">package</span><span class="p">:</span>
    <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">httpd</span>
    <span class="nt">state</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">present</span>

<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Template &gt;&gt; /var/www/html/index.html</span>
  <span class="nt">template</span><span class="p">:</span>
    <span class="nt">src</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">index.html.j2</span>
    <span class="nt">dest</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">/var/www/html/index.html</span>
    <span class="nt">owner</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">root</span>
    <span class="nt">group</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">root</span>
    <span class="nt">mode</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">0644</span>
  <span class="nt">tags</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">templates</span>

<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Start services</span>
  <span class="nt">service</span><span class="p">:</span>
    <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">httpd</span>
    <span class="nt">state</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">started</span>
    <span class="nt">enabled</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>
</pre></div>
</div>
<p>Content is pretty simple:</p>
<ul class="simple">
<li><p>Ansible installs httpd package (or do nothing if present)</p></li>
<li><p>Then Ansible render the template index.html.j2 and write the result in /var/www/html/index.html</p></li>
<li><p>Then Ansible ensure httpd service is started and enabled at boot</p></li>
</ul>
<p>You can find all Ansible modules here in the
<a class="reference external" href="https://docs.ansible.com/ansible/latest/collections/index_module.html">official documentation</a>.</p>
</div>
<div class="section" id="template">
<h4><span class="section-number">4.5.1.2. </span>Template<a class="headerlink" href="#template" title="Permalink to this headline">¶</a></h4>
<p>Templates are probably the key feature of Ansible and all automation tools.</p>
<p>The idea is simple: you provide Ansible with a copy of your desired
configuration file, with variables to be dynamically replaced in order to fill
on the fly some parts of the file.</p>
<p>Let’s do this with a simple html page, and first with a static page.</p>
<p>Create the template /etc/ansible/roles/shipyard/templates/index.html.j2 with the
following static content:</p>
<div class="highlight-html notranslate"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">header</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>This is title<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">header</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
  Hello world
<span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</pre></div>
</div>
<p>The current template is static, we will make it dynamic later.</p>
</div>
</div>
<div class="section" id="playbook">
<h3><span class="section-number">4.5.2. </span>Playbook<a class="headerlink" href="#playbook" title="Permalink to this headline">¶</a></h3>
<p>Lets create our playbook, which will contains a list of roles to apply on
management1 host.</p>
<p>Create file /etc/ansible/playbooks/myplaybook.yml with the following content:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">myplaybook</span>
  <span class="nt">hosts</span><span class="p">:</span> <span class="s">&quot;management1&quot;</span>
  <span class="nt">roles</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="nt">role</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">shipyard</span>
      <span class="nt">tags</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">shipyard</span>
</pre></div>
</div>
<p>Simply put, target of the playbook is host management1, and role to apply is
shipyard.</p>
<p>Skip the tags for now.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Hosts can be a list of hosts (comma separated: management1,login1,nfs1), or a
group of hosts (all, slaves, color, etc.).</p>
</div>
<p>Now, execute the playbook, and let Ansible do its job:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ansible-playbook /path/to/myplaybook.yml
</pre></div>
</div>
<p>Note that you need to provide full path to the playbook, as there are no default
folder for playbooks in Ansible.
Also note that if your shell is currently in the playbook folder, you can skip
full path as relative path are accepted.</p>
<p>If all goes well, you should now have the file /var/www/html/index.html
generated on management1, and using a web browser you can check the result.</p>
<p>Note that if you cannot reach the web browser, for example you are working in a
VM or a server without screen attached, you can use ssh forwarding. From you
current computer, open a new terminal and use:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ssh root@my_vm_or_my_server -L <span class="m">9999</span>:localhost:80
</pre></div>
</div>
<p>And then open a local web browser and open <a class="reference external" href="http://localhost:9999">http://localhost:9999</a> .
Check the web for more on ssh port forwarding.</p>
<img alt="_images/capture_index_1.png" src="_images/capture_index_1.png" />
<p>But this is not very interesting, let’s add some dynamic part into our template.</p>
</div>
<div class="section" id="jinja2">
<h3><span class="section-number">4.5.3. </span>Jinja2<a class="headerlink" href="#jinja2" title="Permalink to this headline">¶</a></h3>
<p>Edit file /etc/ansible/roles/shipyard/templates/index.html.j2 to make it this
way:</p>
<div class="highlight-html notranslate"><div class="highlight"><pre><span></span>&lt;html&gt;
&lt;header&gt;
  &lt;title&gt;Shipyard&lt;/title&gt;
&lt;/header&gt;
&lt;body&gt;
  &lt;h1&gt;I am {{inventory_hostname}} &lt;&lt; this is me, the current target&lt;/h1&gt;
  &lt;h2&gt;Variables access&lt;/h2&gt;
  Ship list: {{groups[&#39;all&#39;]}} &lt;&lt; this is an access to a group members list &lt;br&gt;
  management1 ship model: {{hostvars[&#39;management1&#39;][&#39;my_ship&#39;][&#39;model&#39;]}} &lt;&lt; this is an access to an host specific variable &lt;br&gt;
  login1 ship model: {{hostvars[&#39;login1&#39;][&#39;my_ship&#39;][&#39;model&#39;]}} &lt;br&gt;
  nfs1 ship model: {{hostvars[&#39;nfs1&#39;][&#39;my_ship&#39;][&#39;model&#39;]}} &lt;br&gt;
  My ship model: {{hostvars[inventory_hostname][&#39;my_ship&#39;][&#39;model&#39;]}} &lt;br&gt;
  Or a better way to get my ship model: {{my_ship.model}} &lt;br&gt;
  &lt;h2&gt;Loops&lt;/h2&gt;
  {% for ship in groups[&#39;all&#39;] %}
  Ship {{ship}} is in the shipyard, and has destination {{hostvars[ship][&#39;destination&#39;]}}. &lt;br&gt;
  {% endfor %}
&lt;/body&gt;
&lt;/html&gt;
</pre></div>
</div>
<p>And let’s re-execute the playbook. But we have already installed the package and
started the service, so let’s ask Ansible to only work on the tags ‘templates’
to fasten the execution (this tag was defined in the tasks/mail.yml file
previously seen):</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ansible-playbook myplaybook.yml -t templates
</pre></div>
</div>
<p>And check again our web page.</p>
<img alt="_images/capture_index_2.png" src="_images/capture_index_2.png" />
<p>You can see multiple things:</p>
<ul class="simple">
<li><p>We executed the task on management1, so inventory_hostname variable content is ‘management1’. This is an Ansible reserved variable that contains the target hostname.</p></li>
<li><p>groups[‘mygroup’] allows to get a list with all the hosts member of the group.</p></li>
<li><p>hostvars[‘myhost’] allows to access variables of this host, using the variable precedence mechanism.</p></li>
<li><p>hostvars[inventory_hostname] is equivalent to a direct variables access has we are accessing our current target variables.</p></li>
</ul>
<p>Now regarding to Jinja2:</p>
<ul class="simple">
<li><p>{{ }} allows to insert a variable in the destination file.</p></li>
<li><p>{% %} are Jinja2 instructions (for, if, etc.).</p></li>
<li><p>{# #} are Jinja2 commentaries.</p></li>
<li><p>The remaining is put in the destination file “as is”.</p></li>
</ul>
<p>You can experiment with this template to understand the whole mechanism. The
whole Jinja2 documentation can be found here:
<a class="reference external" href="https://jinja.palletsprojects.com/en/2.10.x/templates/">Jinja2 template designer</a></p>
<p>You should now understand the very basis of Ansible.</p>
<p>Please note also that Ansible provides some built in filters, to be used with
Jinja2. A list can be found here:
<a class="reference external" href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_filters.html">Ansible Filters</a></p>
<p>Time to investigate tasks advanced elements.</p>
</div>
<div class="section" id="task-again">
<h3><span class="section-number">4.5.4. </span>Task again<a class="headerlink" href="#task-again" title="Permalink to this headline">¶</a></h3>
<p>As discussed before, all task available modules can be found in the
<a class="reference external" href="https://docs.ansible.com/ansible/latest/collections/index_module.html">Ansible modules documentation</a> .</p>
<p>Each of these modules can be combined with general tasks actions. But first,
let’s define the basic debug module and registers, that will allow us to play
more easily with tasks.</p>
<p>At this point, use previously created task, or create a new role to add
following tasks.</p>
<div class="section" id="debug-module">
<h4><span class="section-number">4.5.4.1. </span>Debug module<a class="headerlink" href="#debug-module" title="Permalink to this headline">¶</a></h4>
<p>This is a very simple module, to display a message in the shell.</p>
<p>For example:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">My message module</span>
  <span class="nt">debug</span><span class="p">:</span>
    <span class="nt">msg</span><span class="p">:</span> <span class="s">&quot;Hello</span><span class="nv"> </span><span class="s">world</span><span class="nv"> </span><span class="s">!</span><span class="nv"> </span><span class="s">I</span><span class="nv"> </span><span class="s">am</span><span class="nv"> </span><span class="s">the</span><span class="nv"> </span><span class="s">debug</span><span class="nv"> </span><span class="s">module.</span><span class="nv"> </span><span class="s">You</span><span class="nv"> </span><span class="s">will</span><span class="nv"> </span><span class="s">use</span><span class="nv"> </span><span class="s">me</span><span class="nv"> </span><span class="s">a</span><span class="nv"> </span><span class="s">lot.&quot;</span>
</pre></div>
</div>
<p>You can also display variables this way:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">My message module</span>
  <span class="nt">debug</span><span class="p">:</span>
    <span class="nt">msg</span><span class="p">:</span> <span class="s">&quot;Hello</span><span class="nv"> </span><span class="s">world</span><span class="nv"> </span><span class="s">!</span><span class="nv"> </span><span class="s">I</span><span class="nv"> </span><span class="s">am</span><span class="nv"> </span><span class="s">host</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">inventory_hostname</span><span class="nv"> </span><span class="s">}}&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="registers">
<h4><span class="section-number">4.5.4.2. </span>Registers<a class="headerlink" href="#registers" title="Permalink to this headline">¶</a></h4>
<p>Create a file /tmp/valkyrie, and add the string “lenneth” inside, using:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>echo &quot;lenneth&quot; &gt; /tmp/valkyrie
</pre></div>
</div>
<p>Now, lets use a register to gather this content. Registers are a way to gather
data about executed modules. Input data, output data, etc.
A good usage example is combining registers with templates. Register can inform
later tasks that a template was updated or not, and trigger other tasks if
needed.</p>
<p>One of the possible usages is registers combined with shell or commands, to
gather very specific data from the system.</p>
<p>Try:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Get output from a shell command</span>
  <span class="nt">shell</span><span class="p">:</span> <span class="s">&quot;cat</span><span class="nv"> </span><span class="s">/tmp/valkyrie&quot;</span>
  <span class="nt">register</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">my_result</span>
  <span class="nt">ignore_errors</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">True</span>

<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Display content of the register</span>
  <span class="nt">debug</span><span class="p">:</span>
    <span class="nt">msg</span><span class="p">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">my_result</span><span class="nv"> </span><span class="s">}}&quot;</span>
</pre></div>
</div>
<p>And when running, output is:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>TASK [debug : Get output from a shell command] *******************************
changed: [management1]

TASK [debug : My message module] *********************************************
ok: [management1] =&gt;
  msg:
    changed: true
    cmd: cat /tmp/valkyrie
    delta: &#39;0:00:00.016261&#39;
    end: &#39;2020-04-17 14:46:04.490684&#39;
    failed: false
    rc: 0
    start: &#39;2020-04-17 14:46:04.474423&#39;
    stderr: &#39;&#39;
    stderr_lines: []
    stdout: lenneth
    stdout_lines:
    - lenneth
</pre></div>
</div>
<p>So, you can use the register to get status (changed: true, so something
happens), to get return code (<em>rc: 0</em> here), stderr and stdout, if it failed,
etc.</p>
<p>For example:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">My message module</span>
  <span class="nt">debug</span><span class="p">:</span>
    <span class="nt">msg</span><span class="p">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">my_result.stdout</span><span class="nv"> </span><span class="s">}}&quot;</span>
</pre></div>
</div>
<p>Will display “lenneth”.</p>
<p>We are going to use register and debug module to learn generic tasks actions.</p>
</div>
<div class="section" id="loops">
<h4><span class="section-number">4.5.4.3. </span>Loops<a class="headerlink" href="#loops" title="Permalink to this headline">¶</a></h4>
<p>It is possible to make modules iterate. All possibilities are available here in
<a class="reference external" href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_loops.html">loop documentation</a> .</p>
<p>BlueBanquise rely on two methods: <em>with_items</em> and <em>loop</em>. <em>with_items</em> is
considered deprecated by the Ansible team. <em>loop</em>, the replacement, is
progressively being added into the stack.</p>
<p>A first loop example can be:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">My message module</span>
  <span class="nt">debug</span><span class="p">:</span>
    <span class="nt">msg</span><span class="p">:</span> <span class="s">&quot;Values:</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">item</span><span class="nv"> </span><span class="s">}}&quot;</span>
  <span class="nt">loop</span><span class="p">:</span>
     <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">Blue</span>
     <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">Red</span>
     <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">Green</span>
     <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">Yellow</span>
</pre></div>
</div>
<p>This will execute this module 4 times, with each time an element of the list
given as item. When using loops in ansible, the variable <strong>item</strong> stores the
value of the current loop index.</p>
<p>It is also possible to provide the loop with a list from the inventory, like the
one we wrote before:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">My message module</span>
  <span class="nt">debug</span><span class="p">:</span>
    <span class="nt">msg</span><span class="p">:</span> <span class="s">&quot;Values:</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">item</span><span class="nv"> </span><span class="s">}}&quot;</span>
  <span class="nt">loop</span><span class="p">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">my_ship.equipment.sidekicks</span><span class="nv"> </span><span class="s">}}&quot;</span>
</pre></div>
</div>
<p>Loop action can accept advanced filters or patterns. Refer to the Ansible
documentation.</p>
<p>with_items works the same way:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">My message module</span>
  <span class="nt">debug</span><span class="p">:</span>
    <span class="nt">msg</span><span class="p">:</span> <span class="s">&quot;Values:</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">item</span><span class="nv"> </span><span class="s">}}&quot;</span>
  <span class="nt">with_items</span><span class="p">:</span>
     <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">Blue</span>
     <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">Red</span>
     <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">Green</span>
     <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">Yellow</span>

<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">My message module</span>
  <span class="nt">debug</span><span class="p">:</span>
    <span class="nt">msg</span><span class="p">:</span> <span class="s">&quot;Values:</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">item</span><span class="nv"> </span><span class="s">}}&quot;</span>
  <span class="nt">with_items</span><span class="p">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">my_ship.equipment.sidekicks</span><span class="nv"> </span><span class="s">}}&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="conditionals">
<h4><span class="section-number">4.5.4.4. </span>Conditionals<a class="headerlink" href="#conditionals" title="Permalink to this headline">¶</a></h4>
<p>Conditionals are used to skip some modules when not required or optional (or
just don’t meet a specific condition).
All information can be found in
<a class="reference external" href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_conditionals.html">conditionals documentation</a> .</p>
<p>Let’s re-use our previous register, and display a message only if content is
“lenneth”:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Get output from a shell command</span>
  <span class="nt">shell</span><span class="p">:</span> <span class="s">&quot;cat</span><span class="nv"> </span><span class="s">/tmp/valkyrie&quot;</span>
  <span class="nt">register</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">my_result</span>
  <span class="nt">ignore_errors</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">True</span>

<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Display content of the register</span>
  <span class="nt">debug</span><span class="p">:</span>
    <span class="nt">msg</span><span class="p">:</span> <span class="s">&quot;Profile&quot;</span>
  <span class="nt">when</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">my_result.stdout == &quot;lenneth&quot;</span>
</pre></div>
</div>
<p>If content is not “lenneth”, you will see:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>TASK [debug : Display content of the register] *******************************
skipping: [management1]
</pre></div>
</div>
<p>So this part of the task was skipped, because our my_result.stdout does not meet
the condition.</p>
<p>Now, let’s combine loop and conditions.</p>
<p>Fill /tmp/valkyrie file with multiple lines:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>echo &quot;freya&quot; &gt; /tmp/valkyrie
echo &quot;lenneth&quot; &gt;&gt; /tmp/valkyrie
echo &quot;odin&quot; &gt;&gt; /tmp/valkyrie
echo &quot;loki&quot; &gt;&gt; /tmp/valkyrie
</pre></div>
</div>
<p>We are now going to use the stdout_lines of our register, as it is a list
containing line by line the output of stdout, so here the content of our file.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Get output from a shell command</span>
  <span class="nt">shell</span><span class="p">:</span> <span class="s">&quot;cat</span><span class="nv"> </span><span class="s">/tmp/valkyrie&quot;</span>
  <span class="nt">register</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">my_result</span>
  <span class="nt">ignore_errors</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">True</span>

<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Display content of the register</span>
  <span class="nt">debug</span><span class="p">:</span>
    <span class="nt">msg</span><span class="p">:</span> <span class="s">&quot;Profile&quot;</span>
  <span class="nt">loop</span><span class="p">:</span> <span class="s">&quot;{{my_result.stdout_lines}}&quot;</span>
  <span class="nt">when</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">item == &quot;lenneth&quot;</span>
</pre></div>
</div>
<p>And result should be:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>TASK [debug : Display content of the register] *******************************
skipping: [management1] =&gt; (item=freya)
ok: [management1] =&gt; (item=lenneth) =&gt;
  msg: Profile
skipping: [management1] =&gt; (item=odin)
skipping: [management1] =&gt; (item=loki)
</pre></div>
</div>
<p>Note that all the items are displayed here.</p>
<p>Last part is to combine conditions. It is possible to stack conditions,
considering that the list is interpreted as AND conditions by Ansible.</p>
<p>For example:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Get output from a shell command</span>
  <span class="nt">shell</span><span class="p">:</span> <span class="s">&quot;cat</span><span class="nv"> </span><span class="s">/tmp/valkyrie&quot;</span>
  <span class="nt">register</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">my_result</span>
  <span class="nt">ignore_errors</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">True</span>

<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Display content of the register</span>
  <span class="nt">debug</span><span class="p">:</span>
    <span class="nt">msg</span><span class="p">:</span> <span class="s">&quot;Profile&quot;</span>
  <span class="nt">loop</span><span class="p">:</span> <span class="s">&quot;{{my_result.stdout_lines}}&quot;</span>
  <span class="nt">when</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">item == &quot;lenneth&quot;</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">sys_admin_is_master == &quot;yes&quot;</span>  <span class="c1"># &lt;&lt;&lt; this is added as an AND with other conditions</span>
</pre></div>
</div>
<p>Now execute playbook with an additional variable as extra vars, first with “no”,
then with “yes”:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>ansible-playbook ... -e sys_admin_is_master=no
ansible-playbook ... -e sys_admin_is_master=yes
</pre></div>
</div>
<p>First time, you get:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>TASK [debug : Display content of the register] *******************************
skipping: [management1] =&gt; (item=freya)
skipping: [management1] =&gt; (item=lenneth)
skipping: [management1] =&gt; (item=odin)
skipping: [management1] =&gt; (item=loki)
</pre></div>
</div>
<p>And second time:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>TASK [debug : Display content of the register] *******************************
skipping: [management1] =&gt; (item=freya)
ok: [management1] =&gt; (item=lenneth) =&gt;
  msg: Profile
skipping: [management1] =&gt; (item=odin)
skipping: [management1] =&gt; (item=loki)
</pre></div>
</div>
<p>So it acted as a logical AND.</p>
</div>
<div class="section" id="tags">
<h4><span class="section-number">4.5.4.5. </span>Tags<a class="headerlink" href="#tags" title="Permalink to this headline">¶</a></h4>
<p>Tags act like the name: they tag part of the task, or role, so you can execute
only this part, or skip it.</p>
<p>For example:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Display content of the register</span>
  <span class="nt">debug</span><span class="p">:</span>
    <span class="nt">msg</span><span class="p">:</span> <span class="s">&quot;Les</span><span class="nv"> </span><span class="s">sanglots</span><span class="nv"> </span><span class="s">longs&quot;</span>
  <span class="nt">tags</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">first</span>

<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Display content of the register</span>
  <span class="nt">debug</span><span class="p">:</span>
    <span class="nt">msg</span><span class="p">:</span> <span class="s">&quot;des</span><span class="nv"> </span><span class="s">violons</span><span class="nv"> </span><span class="s">de</span><span class="nv"> </span><span class="s">l&#39;automne&quot;</span>
  <span class="nt">tags</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">second</span>
</pre></div>
</div>
<p>And at execution, use <code class="docutils literal notranslate"><span class="pre">--tags</span> <span class="pre">first,second</span></code> to execute both, <code class="docutils literal notranslate"><span class="pre">--tags</span> <span class="pre">second</span></code>
to execute second only, or <code class="docutils literal notranslate"><span class="pre">--skip-tags</span> <span class="pre">first</span></code> that will skip the first one.</p>
</div>
<div class="section" id="notify">
<h4><span class="section-number">4.5.4.6. </span>Notify<a class="headerlink" href="#notify" title="Permalink to this headline">¶</a></h4>
<p>Sometime, you may wish that some actions take place at the end of each role, if
a module returned a <strong>changed</strong> status.
Best example: your role is dedicated to a service, and Ansible generate the
configuration file using a template.
You may want that this service is restarted if Ansible detect changes in the
file when executing.</p>
<p>Notify will be your friend for such cases.</p>
<p>Create a new directory at root of your role, called <strong>handlers</strong>, and then
inside a file called <strong>main.yml</strong>, with the following content:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">There was a change</span>
  <span class="nt">debug</span><span class="p">:</span>
    <span class="nt">msg</span><span class="p">:</span> <span class="s">&quot;THE</span><span class="nv"> </span><span class="s">FILE</span><span class="nv"> </span><span class="s">WAS</span><span class="nv"> </span><span class="s">CHANGED!!</span><span class="nv"> </span><span class="s">HOW</span><span class="nv"> </span><span class="s">DARE</span><span class="nv"> </span><span class="s">YOU!!&quot;</span>
</pre></div>
</div>
<p>Note that the name of this task (<code class="docutils literal notranslate"><span class="pre">There</span> <span class="pre">was</span> <span class="pre">a</span> <span class="pre">change</span></code>) is important and will
be targeted by the notify.</p>
<p>Create also a template, called our_file.j2 in templates folder (like handlers
above), with the following content:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>{{ my_value }}
</pre></div>
</div>
<p>Now, in the main task, use this code:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Display message</span>
  <span class="nt">debug</span><span class="p">:</span>
    <span class="nt">msg</span><span class="p">:</span> <span class="s">&quot;Hello</span><span class="nv"> </span><span class="s">world&quot;</span>

<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Template /tmp/out</span>
  <span class="nt">template</span><span class="p">:</span>
    <span class="nt">src</span><span class="p">:</span> <span class="s">&quot;our_file.j2&quot;</span>
    <span class="nt">dest</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">/tmp/out</span>
    <span class="nt">owner</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">root</span>
    <span class="nt">group</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">root</span>
    <span class="nt">mode</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">0644</span>
  <span class="nt">notify</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">There was a change</span>

<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Display another message</span>
  <span class="nt">debug</span><span class="p">:</span>
    <span class="nt">msg</span><span class="p">:</span> <span class="s">&quot;Hello</span><span class="nv"> </span><span class="s">world</span><span class="nv"> </span><span class="s">again.</span><span class="nv"> </span><span class="s">How</span><span class="nv"> </span><span class="s">do</span><span class="nv"> </span><span class="s">you</span><span class="nv"> </span><span class="s">do</span><span class="nv"> </span><span class="s">by</span><span class="nv"> </span><span class="s">the</span><span class="nv"> </span><span class="s">way</span><span class="nv"> </span><span class="s">?&quot;</span>
</pre></div>
</div>
<p>And execute adding an extra var:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>ansible-playbook ... -e my_value=kirk
</pre></div>
</div>
<p>First time execution, of course, you will see both:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>TASK [debug : Template /tmp/out] *********************************************
changed: [management1]

...

RUNNING HANDLER [debug : There was a change] *********************************
ok: [management1] =&gt;
  msg: THE FILE WAS CHANGED!! HOW DARE YOU!!
</pre></div>
</div>
<p>As expected, because there was a change, so the handler was called <strong>at the end
of the role</strong>.</p>
<p>Now do the exact same command again.</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>TASK [debug : Template /tmp/out] *********************************************
ok: [management1]
</pre></div>
</div>
<p>Handler was not activated, because there was no changes.</p>
<p>Last test, change captain of the enterprise (Kirk is on a mission).</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>ansible-playbook ... -e my_value=spock
</pre></div>
</div>
<p>And again:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>TASK [debug : Template /tmp/out] *********************************************
changed: [management1]

...

RUNNING HANDLER [debug : There was a change] *********************************
ok: [management1] =&gt;
  msg: THE FILE WAS CHANGED!! HOW DARE YOU!!
</pre></div>
</div>
<p>Handler was activated.</p>
</div>
<div class="section" id="other-useful-modules">
<h4><span class="section-number">4.5.4.7. </span>Other useful modules<a class="headerlink" href="#other-useful-modules" title="Permalink to this headline">¶</a></h4>
<p>A full list of all Ansible modules can be found on the
<a class="reference external" href="https://docs.ansible.com/ansible/latest/modules/list_of_all_modules.html">Ansible documentation</a> .</p>
<p>However, lets review the most commonly used modules:</p>
<div class="section" id="package">
<h5><span class="section-number">4.5.4.7.1. </span>Package<a class="headerlink" href="#package" title="Permalink to this headline">¶</a></h5>
<p>This module simply installs a list of packages. It can be used instead of the yum
or dnf modules, as it covers both.</p>
<p>Example:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Install wget package</span>
  <span class="nt">package</span><span class="p">:</span>
    <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">wget</span>
    <span class="nt">state</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">present</span>

<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Install a list of packages</span>
  <span class="nt">package</span><span class="p">:</span>
    <span class="nt">name</span><span class="p">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">my_packages_list</span><span class="nv"> </span><span class="s">}}&quot;</span>
    <span class="nt">state</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">present</span>
</pre></div>
</div>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference external" href="https://docs.ansible.com/ansible/latest/modules/package_module.html">https://docs.ansible.com/ansible/latest/modules/package_module.html</a></p>
</div>
</div>
<div class="section" id="service">
<h5><span class="section-number">4.5.4.7.2. </span>Service<a class="headerlink" href="#service" title="Permalink to this headline">¶</a></h5>
<p>Manage services, to start/stop/restart, enable/disable.</p>
<p>Example:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Start and enable httpd service</span>
  <span class="nt">service</span><span class="p">:</span>
    <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">httpd</span>
    <span class="nt">enabled</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>
    <span class="nt">state</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">started</span>
</pre></div>
</div>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference external" href="https://docs.ansible.com/ansible/latest/modules/service_module.html">https://docs.ansible.com/ansible/latest/modules/service_module.html</a></p>
</div>
</div>
<div class="section" id="file">
<h5><span class="section-number">4.5.4.7.3. </span>File<a class="headerlink" href="#file" title="Permalink to this headline">¶</a></h5>
<p>This module allows to create folders.</p>
<p>Example:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Create custom folders</span>
  <span class="nt">file</span><span class="p">:</span>
    <span class="nt">path</span><span class="p">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">item</span><span class="nv"> </span><span class="s">}}&quot;</span>
    <span class="nt">state</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">directory</span>
    <span class="nt">mode</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">0755</span>
  <span class="nt">loop</span><span class="p">:</span>
   <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">/etc/my_folder</span>
   <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">/var/lib/my_other_folder</span>
</pre></div>
</div>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference external" href="https://docs.ansible.com/ansible/latest/modules/file_module.html">https://docs.ansible.com/ansible/latest/modules/file_module.html</a></p>
</div>
</div>
<div class="section" id="copy">
<h5><span class="section-number">4.5.4.7.4. </span>Copy<a class="headerlink" href="#copy" title="Permalink to this headline">¶</a></h5>
<p>Act like template, but simply copy file, no rendering.
Files to be copied must be put into a <strong>files</strong> folder, at root of the role.</p>
<p>For example, create file my_role/files/slurm.conf</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Copy slurm static file</span>
  <span class="nt">copy</span><span class="p">:</span>
    <span class="nt">src</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">slurm.conf</span>
    <span class="nt">dest</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">/etc/slurm/slurm.conf</span>
    <span class="nt">mode</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">0644</span>
    <span class="nt">owner</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">slurm</span>
    <span class="nt">group</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">slurm</span>
</pre></div>
</div>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference external" href="https://docs.ansible.com/ansible/latest/modules/copy_module.html">https://docs.ansible.com/ansible/latest/modules/copy_module.html</a></p>
</div>
</div>
<div class="section" id="lineinfile">
<h5><span class="section-number">4.5.4.7.5. </span>Lineinfile<a class="headerlink" href="#lineinfile" title="Permalink to this headline">¶</a></h5>
<p>This module allows to manipulate files, using regex. For example, set a value to
0 in a file.</p>
<p>Example:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Add mymanagement string to localhost in /etc/hosts</span>
  <span class="nt">lineinfile</span><span class="p">:</span>
    <span class="nt">path</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">/etc/hosts</span>
    <span class="nt">regexp</span><span class="p">:</span> <span class="s">&#39;^127\.0\.0\.1&#39;</span>
    <span class="nt">line</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">127.0.0.1 localhost mymanagement</span>
</pre></div>
</div>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference external" href="https://docs.ansible.com/ansible/latest/modules/lineinfile_module.html">https://docs.ansible.com/ansible/latest/modules/lineinfile_module.html</a></p>
</div>
</div>
<div class="section" id="include-vars">
<h5><span class="section-number">4.5.4.7.6. </span>Include_vars<a class="headerlink" href="#include-vars" title="Permalink to this headline">¶</a></h5>
<p>Allow to include vars from a file. Mostly used to allow compatibility with
multiple architectures / OS versions, etc. To be used when “defaults” cannot be
used.
Vars file must be placed in a dedicated vars folder at root of the role
(myrole/vars/myvars.yml).</p>
<p>Example:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Include vars from file &quot;myvars.yml&quot;</span>
  <span class="nt">include_vars</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">myvars.yml</span>
</pre></div>
</div>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference external" href="https://docs.ansible.com/ansible/latest/modules/include_vars_module.html">https://docs.ansible.com/ansible/latest/modules/include_vars_module.html</a></p>
</div>
</div>
<div class="section" id="include-tasks">
<h5><span class="section-number">4.5.4.7.7. </span>Include_tasks<a class="headerlink" href="#include-tasks" title="Permalink to this headline">¶</a></h5>
<p>Allows to split the main.yml task file into multiple chunks (using or not
conditionals).</p>
<p>Example:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Include addon tasks</span>
  <span class="nt">include_tasks</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">addon.yml</span>
  <span class="nt">when</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">my_role_addon == true</span>
</pre></div>
</div>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference external" href="https://docs.ansible.com/ansible/latest/modules/include_tasks_module.html">https://docs.ansible.com/ansible/latest/modules/include_tasks_module.html</a></p>
</div>
</div>
<div class="section" id="command-and-shell">
<h5><span class="section-number">4.5.4.7.8. </span>Command and shell<a class="headerlink" href="#command-and-shell" title="Permalink to this headline">¶</a></h5>
<p>Sometime, you need to do things manually. Two modules allows that: command and
shell.</p>
<ul class="simple">
<li><p>Command is to be used when you need to execute a very basic command.</p></li>
<li><p>Shell is to be used when you need to execute a command inside a shell (to benefit from it).</p></li>
</ul>
<p>When using pipes, or output redirections, shell is preferred for example.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Store content of a file into a register</span>
  <span class="nt">command</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">cat /etc/myfile</span>
  <span class="nt">register</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">myfile_content</span>

<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Execute a script, pipe it, and stdout goes to log.txt on the remote host</span>
  <span class="nt">shell</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">myscript.sh | grep -E &quot;in|out&quot;&gt;&gt; log.txt</span>
</pre></div>
</div>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference external" href="https://docs.ansible.com/ansible/latest/modules/shell_module.html#shell-module">https://docs.ansible.com/ansible/latest/modules/shell_module.html#shell-module</a></p>
</div>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference external" href="https://docs.ansible.com/ansible/latest/modules/command_module">https://docs.ansible.com/ansible/latest/modules/command_module</a></p>
</div>
<hr class="docutils" />
<p>You can find a lot more on the web regarding Ansible. However, this small guide
should have provided you the very basis of Ansible.</p>
<p>If you feel something is missing in this quick Ansible training, please do not
hesitate to ask us to add elements.</p>
<p>Time to move on to BlueBanquise stack itself, and bootstrap first management
server.</p>
</div>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="bootstrap.html" class="btn btn-neutral float-right" title="5. [Core] - Bootstrap base system" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="training_sysadmin.html" class="btn btn-neutral float-left" title="3. [Training] - Cluster SysAdmin" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2019, Benoît Leveugle, Johnny Keats.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>